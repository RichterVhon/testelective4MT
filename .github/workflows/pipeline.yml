name: Image Processing CI/CD

on: [push]  # Triggers on ALL branches

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Tools
      run: |
        pip install opencv-python-headless numpy pytest pytest-html
    
    - name: Run Processor to Generate Files
      run: |
        # This ensures the processor runs BEFORE the test checks for the file
        python processor.py 
        # Optional: list files so you can see them in the logs if it fails
        ls -R output/
        
    - name: Run Quality Tests
      # This runs your tests and generates the professional HTML report
      run: pytest --html=report.html --self-contained-html

    - name: Save Automated Logs
      # This stores the report as a downloadable file in the "Actions" tab
      uses: actions/upload-artifact@v4
      with:
        name: quality-report-run-${{ github.run_number }}
        path: report.html

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ghcr.io/richtervhon/testelective4mt:latest